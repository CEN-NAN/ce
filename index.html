<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园校花评选</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#E9446A',
                        secondary: '#3498db',
                        accent: '#f39c12',
                        dark: '#2c3e50',
                        light: '#f8f9fa'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .hover-scale {
                transition: transform 0.3s ease;
            }
            .hover-scale:hover {
                transform: scale(1.03);
            }
            .vote-animation {
                animation: votePulse 0.5s ease;
            }
            @keyframes votePulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-light to-gray-100 min-h-screen">
    <!-- 页面顶部 -->
    <header class="bg-white shadow-md sticky top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fa fa-graduation-cap text-primary text-3xl mr-3"></i>
                <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark">校园校花评选</h1>
            </div>
            <div class="flex items-center">
                <p id="vote-status" class="hidden md:block mr-4 text-gray-600">
                    <i class="fa fa-info-circle mr-1"></i>
                    <span>您尚未投票</span>
                </p>
                <button id="rules-btn" class="bg-secondary hover:bg-secondary/90 text-white px-4 py-2 rounded-lg transition-all flex items-center">
                    <i class="fa fa-book mr-2"></i>评选规则
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 活动介绍 -->
        <section class="bg-white rounded-xl p-6 mb-10 shadow-lg">
            <h2 class="text-[clamp(1.2rem,2vw,1.8rem)] font-bold text-primary mb-4 flex items-center">
                <i class="fa fa-star mr-2"></i>活动介绍
            </h2>
            <p class="text-gray-700 leading-relaxed">
                欢迎参与本届校园校花评选活动！请为您支持的候选人投上宝贵的一票。每个参与者仅限投票一次，投票结果将实时展示在排行榜中。
                您也可以在评论区留下您的看法和祝福。
            </p>
        </section>

        <!-- 候选人展示区 -->
        <section class="mb-16">
            <h2 class="text-[clamp(1.2rem,2vw,1.8rem)] font-bold text-dark mb-6 flex items-center">
                <i class="fa fa-users mr-2 text-primary"></i>候选人列表
            </h2>
            
            <div id="candidates-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- 候选人卡片将通过JavaScript动态生成 -->
            </div>
            
            <!-- 管理员添加候选人按钮（仅管理员可见） -->
            <div id="add-candidate-container" class="hidden mt-8 text-center">
                <button id="add-candidate-btn" class="bg-accent hover:bg-accent/90 text-white px-6 py-3 rounded-lg transition-all flex items-center mx-auto">
                    <i class="fa fa-plus-circle mr-2"></i>添加新候选人
                </button>
            </div>
        </section>

        <!-- 排行榜区域 -->
        <section class="mb-16">
            <h2 class="text-[clamp(1.2rem,2vw,1.8rem)] font-bold text-dark mb-6 flex items-center">
                <i class="fa fa-trophy mr-2 text-accent"></i>实时排行榜
            </h2>
            
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="grid grid-cols-12 bg-dark text-white py-3 px-6 font-bold">
                    <div class="col-span-1">排名</div>
                    <div class="col-span-6 md:col-span-7">候选人</div>
                    <div class="col-span-3 md:col-span-2">票数</div>
                    <div class="col-span-2 md:col-span-2">占比</div>
                </div>
                <div id="ranking-list" class="divide-y">
                    <!-- 排行榜内容将通过JavaScript动态生成 -->
                </div>
            </div>
        </section>

        <!-- 评论区 -->
        <section class="mb-16">
            <h2 class="text-[clamp(1.2rem,2vw,1.8rem)] font-bold text-dark mb-6 flex items-center">
                <i class="fa fa-comments mr-2 text-secondary"></i>评论区
            </h2>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <!-- 评论输入区 -->
                <div class="mb-8">
                    <div class="flex">
                        <textarea 
                            id="comment-input" 
                            placeholder="写下您的评论..." 
                            class="flex-1 border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none transition-all"
                            rows="3"
                            disabled
                        ></textarea>
                    </div>
                    <div class="flex justify-end mt-3">
                        <button id="submit-comment" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            提交评论
                        </button>
                    </div>
                </div>
                
                <!-- 评论列表 -->
                <div id="comments-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <!-- 评论将通过JavaScript动态生成 -->
                    <div class="text-center text-gray-500 py-8">
                        暂无评论，快来发表第一条评论吧！
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p>&copy; 2023 校园校花评选活动 版权所有</p>
                </div>
                
                <!-- 管理员登录入口 -->
                <div class="w-full md:w-auto">
                    <div class="flex items-center">
                        <input 
                            type="password" 
                            id="admin-password" 
                            placeholder="管理员密码" 
                            class="px-4 py-2 rounded-l-lg focus:outline-none text-dark w-full md:w-48"
                        >
                        <button id="admin-login" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-r-lg transition-all">
                            进入管理模式
                        </button>
                    </div>
                    <p id="admin-login-message" class="text-xs mt-2 text-gray-400 text-center md:text-right hidden"></p>
                </div>
            </div>
        </div>
    </footer>

    <!-- 管理员控制面板（默认隐藏） -->
    <div id="admin-panel" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-dark">管理员控制面板</h3>
                <button id="close-admin-panel" class="text-gray-500 hover:text-dark">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <h4 class="text-lg font-semibold mb-4 text-dark">候选人管理</h4>
                
                <div id="admin-candidates-list" class="space-y-4 mb-8">
                    <!-- 管理员视角的候选人列表将通过JavaScript动态生成 -->
                </div>
                
                <h4 class="text-lg font-semibold mb-4 text-dark">系统数据</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-gray-500 text-sm">总候选人</p>
                        <p id="total-candidates" class="text-2xl font-bold text-dark">0</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-gray-500 text-sm">总投票数</p>
                        <p id="total-votes" class="text-2xl font-bold text-dark">0</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-gray-500 text-sm">总评论数</p>
                        <p id="total-comments" class="text-2xl font-bold text-dark">0</p>
                    </div>
                </div>
                
                <button id="reset-all-data" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all">
                    <i class="fa fa-refresh mr-1"></i> 重置所有数据
                </button>
            </div>
        </div>
    </div>

    <!-- 添加/编辑候选人弹窗（默认隐藏） -->
    <div id="candidate-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-dark">添加新候选人</h3>
                <button id="close-modal" class="text-gray-500 hover:text-dark">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <form id="candidate-form">
                    <input type="hidden" id="candidate-id">
                    
                    <div class="mb-4">
                        <label for="candidate-name" class="block text-gray-700 mb-2">姓名</label>
                        <input 
                            type="text" 
                            id="candidate-name" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                            required
                        >
                    </div>
                    
                    <div class="mb-4">
                        <label for="candidate-class" class="block text-gray-700 mb-2">班级</label>
                        <input 
                            type="text" 
                            id="candidate-class" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                            required
                        >
                    </div>
                    
                    <div class="mb-4">
                        <label for="candidate-desc" class="block text-gray-700 mb-2">个人简介</label>
                        <textarea 
                            id="candidate-desc" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"
                            rows="3"
                            required
                        ></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label for="candidate-image" class="block text-gray-700 mb-2">照片URL</label>
                        <input 
                            type="url" 
                            id="candidate-image" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                            placeholder="https://example.com/image.jpg"
                            required
                        >
                    </div>
                    
                    <div class="mb-4 hidden" id="votes-input-container">
                        <label for="candidate-votes" class="block text-gray-700 mb-2">票数</label>
                        <input 
                            type="number" 
                            id="candidate-votes" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                            min="0"
                            value="0"
                        >
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancel-candidate" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">
                            取消
                        </button>
                        <button type="submit" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 规则弹窗 -->
    <div id="rules-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-dark">评选规则</h3>
                <button id="close-rules-modal" class="text-gray-500 hover:text-dark">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <ul class="space-y-3 text-gray-700">
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                        <span>每个参与者仅限为一位候选人投票一次</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                        <span>投票后可以在评论区发表您的看法</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                        <span>投票结果实时更新，可在排行榜查看</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                        <span>请勿发布不当言论，管理员有权删除违规评论</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                        <span>活动最终解释权归主办方所有</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 确认弹窗 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold text-dark">确认操作</h3>
            </div>
            
            <div class="p-6">
                <p id="confirm-message" class="text-gray-700 mb-6">您确定要执行此操作吗？</p>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancel-confirm" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">
                        取消
                    </button>
                    <button id="confirm-action" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all">
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let candidates = [];
        let comments = [];
        let hasVoted = false;
        let votedCandidateId = null;
        let isAdmin = false;
        const ADMIN_PASSWORD = 'admin123'; // 管理员密码，实际应用中应加密存储
        
        // DOM元素
        const candidatesContainer = document.getElementById('candidates-container');
        const rankingList = document.getElementById('ranking-list');
        const commentsList = document.getElementById('comments-list');
        const commentInput = document.getElementById('comment-input');
        const submitCommentBtn = document.getElementById('submit-comment');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login');
        const adminLoginMessage = document.getElementById('admin-login-message');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdminPanelBtn = document.getElementById('close-admin-panel');
        const addCandidateBtn = document.getElementById('add-candidate-btn');
        const addCandidateContainer = document.getElementById('add-candidate-container');
        const candidateModal = document.getElementById('candidate-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelCandidateBtn = document.getElementById('cancel-candidate');
        const candidateForm = document.getElementById('candidate-form');
        const modalTitle = document.getElementById('modal-title');
        const candidateIdInput = document.getElementById('candidate-id');
        const votesInputContainer = document.getElementById('votes-input-container');
        const totalCandidatesEl = document.getElementById('total-candidates');
        const totalVotesEl = document.getElementById('total-votes');
        const totalCommentsEl = document.getElementById('total-comments');
        const resetAllDataBtn = document.getElementById('reset-all-data');
        const adminCandidatesList = document.getElementById('admin-candidates-list');
        const voteStatusEl = document.getElementById('vote-status');
        const voteStatusText = voteStatusEl.querySelector('span');
        const rulesBtn = document.getElementById('rules-btn');
        const rulesModal = document.getElementById('rules-modal');
        const closeRulesModalBtn = document.getElementById('close-rules-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessageEl = document.getElementById('confirm-message');
        const cancelConfirmBtn = document.getElementById('cancel-confirm');
        const confirmActionBtn = document.getElementById('confirm-action');
        
        // 初始化应用
        function initApp() {
            loadData();
            updateUI();
            setupEventListeners();
        }
        
        // 从localStorage加载数据
        function loadData() {
            // 加载候选人
            const savedCandidates = localStorage.getItem('beautyContestCandidates');
            if (savedCandidates) {
                candidates = JSON.parse(savedCandidates);
            } else {
                // 默认候选人
                candidates = [
                    {
                        id: '1',
                        name: '张雨晴',
                        className: '高一(3)班',
                        description: '热爱绘画，性格开朗，是班级里的文艺委员。',
                        image: 'https://picsum.photos/id/237/400/500',
                        votes: 0
                    },
                    {
                        id: '2',
                        name: '李梦琪',
                        className: '高二(1)班',
                        description: '学霸一枚，同时也是学校篮球队的主力队员。',
                        image: 'https://picsum.photos/id/238/400/500',
                        votes: 0
                    },
                    {
                        id: '3',
                        name: '王雅婷',
                        className: '高三(2)班',
                        description: '擅长钢琴演奏，曾获得市级比赛一等奖。',
                        image: 'https://picsum.photos/id/239/400/500',
                        votes: 0
                    }
                ];
                saveCandidates();
            }
            
            // 加载评论
            const savedComments = localStorage.getItem('beautyContestComments');
            if (savedComments) {
                comments = JSON.parse(savedComments);
            }
            
            // 加载投票状态
            const voteStatus = localStorage.getItem('beautyContestVoteStatus');
            if (voteStatus) {
                const status = JSON.parse(voteStatus);
                hasVoted = status.hasVoted;
                votedCandidateId = status.votedCandidateId;
            }
        }
        
        // 保存候选人数据到localStorage
        function saveCandidates() {
            localStorage.setItem('beautyContestCandidates', JSON.stringify(candidates));
        }
        
        // 保存评论数据到localStorage
        function saveComments() {
            localStorage.setItem('beautyContestComments', JSON.stringify(comments));
        }
        
        // 保存投票状态到localStorage
        function saveVoteStatus() {
            localStorage.setItem('beautyContestVoteStatus', JSON.stringify({
                hasVoted,
                votedCandidateId
            }));
        }
        
        // 更新整个UI
        function updateUI() {
            renderCandidates();
            renderRanking();
            renderComments();
            updateVoteStatus();
            updateAdminPanel();
            updateStatistics();
            
            // 根据投票状态启用/禁用评论框
            commentInput.disabled = !hasVoted;
        }
        
        // 渲染候选人列表
        function renderCandidates() {
            candidatesContainer.innerHTML = '';
            
            if (candidates.length === 0) {
                candidatesContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fa fa-info-circle text-3xl mb-3"></i>
                        <p>暂无候选人，请等待管理员添加</p>
                    </div>
                `;
                return;
            }
            
            candidates.forEach(candidate => {
                const candidateCard = document.createElement('div');
                candidateCard.className = 'bg-white rounded-xl overflow-hidden shadow-lg hover-scale';
                
                // 检查是否已经为该候选人投票
                const userVotedForThis = hasVoted && votedCandidateId === candidate.id;
                
                candidateCard.innerHTML = `
                    <div class="relative">
                        <img src="${candidate.image}" alt="${candidate.name}的照片" class="w-full h-64 object-cover">
                        ${userVotedForThis ? `
                            <div class="absolute top-3 right-3 bg-primary text-white text-sm px-3 py-1 rounded-full flex items-center">
                                <i class="fa fa-check mr-1"></i> 已投票
                            </div>
                        ` : ''}
                    </div>
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-dark">${candidate.name}</h3>
                            <span class="bg-gray-100 text-gray-600 text-sm px-2 py-1 rounded">${candidate.className}</span>
                        </div>
                        <p class="text-gray-600 mb-4 text-sm">${candidate.description}</p>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center text-gray-500">
                                <i class="fa fa-thumbs-up mr-1"></i>
                                <span>${candidate.votes} 票</span>
                            </div>
                            <button class="vote-btn bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all ${hasVoted ? 'opacity-50 cursor-not-allowed' : ''}" 
                                    data-id="${candidate.id}"
                                    ${hasVoted ? 'disabled' : ''}>
                                投票
                            </button>
                        </div>
                    </div>
                `;
                
                candidatesContainer.appendChild(candidateCard);
            });
            
            // 添加投票按钮事件监听
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', handleVote);
            });
        }
        
        // 渲染排行榜
        function renderRanking() {
            rankingList.innerHTML = '';
            
            if (candidates.length === 0) {
                rankingList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        暂无候选人数据
                    </div>
                `;
                return;
            }
            
            // 按票数排序，降序
            const sortedCandidates = [...candidates].sort((a, b) => b.votes - a.votes);
            
            // 计算总票数
            const totalVotes = sortedCandidates.reduce((sum, candidate) => sum + candidate.votes, 0);
            
            sortedCandidates.forEach((candidate, index) => {
                const rankingItem = document.createElement('div');
                rankingItem.className = 'grid grid-cols-12 py-4 px-6 items-center hover:bg-gray-50 transition-all';
                
                // 计算得票率
                const votePercentage = totalVotes > 0 ? Math.round((candidate.votes / totalVotes) * 100) : 0;
                
                // 排名样式
                let rankStyle = '';
                if (index === 0) rankStyle = 'bg-yellow-100 text-yellow-600';
                else if (index === 1) rankStyle = 'bg-gray-200 text-gray-600';
                else if (index === 2) rankStyle = 'bg-orange-200 text-orange-600';
                
                rankingItem.innerHTML = `
                    <div class="col-span-1 font-bold ${rankStyle} w-8 h-8 flex items-center justify-center rounded-full">
                        ${index + 1}
                    </div>
                    <div class="col-span-6 md:col-span-7 flex items-center">
                        <img src="${candidate.image}" alt="${candidate.name}的照片" class="w-12 h-12 rounded-full object-cover mr-3">
                        <div>
                            <p class="font-semibold text-dark">${candidate.name}</p>
                            <p class="text-sm text-gray-500">${candidate.className}</p>
                        </div>
                    </div>
                    <div class="col-span-3 md:col-span-2 font-semibold text-dark">${candidate.votes} 票</div>
                    <div class="col-span-2 md:col-span-2">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full" style="width: ${votePercentage}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${votePercentage}%</p>
                    </div>
                `;
                
                rankingList.appendChild(rankingItem);
            });
        }
        
        // 渲染评论列表
        function renderComments() {
            commentsList.innerHTML = '';
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        暂无评论，快来发表第一条评论吧！
                    </div>
                `;
                return;
            }
            
            comments.forEach((comment, index) => {
                const commentItem = document.createElement('div');
                commentItem.className = 'bg-gray-50 p-4 rounded-lg border border-gray-100';
                
                // 格式化日期
                const date = new Date(comment.timestamp);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                commentItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center text-primary mr-2">
                                <i class="fa fa-user"></i>
                            </div>
                            <p class="font-medium text-dark">用户${comment.userId}</p>
                        </div>
                        <p class="text-xs text-gray-500">${formattedDate}</p>
                    </div>
                    <p class="text-gray-700 mb-3">${comment.content}</p>
                    ${isAdmin ? `
                        <div class="flex justify-end">
                            <button class="delete-comment text-red-500 hover:text-red-600 text-sm" data-index="${index}">
                                <i class="fa fa-trash-o mr-1"></i>删除
                            </button>
                        </div>
                    ` : ''}
                `;
                
                commentsList.appendChild(commentItem);
            });
            
            // 滚动到最新评论
            commentsList.scrollTop = commentsList.scrollHeight;
            
            // 添加删除评论事件监听（仅管理员）
            if (isAdmin) {
                document.querySelectorAll('.delete-comment').forEach(btn => {
                    btn.addEventListener('click', handleDeleteComment);
                });
            }
        }
        
        // 更新投票状态显示
        function updateVoteStatus() {
            if (hasVoted && votedCandidateId) {
                const candidate = candidates.find(c => c.id === votedCandidateId);
                if (candidate) {
                    voteStatusText.textContent = `您已为 ${candidate.name} 投票`;
                }
            } else {
                voteStatusText.textContent = '您尚未投票';
            }
        }
        
        // 更新管理员面板
        function updateAdminPanel() {
            // 显示或隐藏管理员功能
            addCandidateContainer.classList.toggle('hidden', !isAdmin);
            
            // 渲染管理员视角的候选人列表
            renderAdminCandidatesList();
        }
        
        // 渲染管理员视角的候选人列表
        function renderAdminCandidatesList() {
            adminCandidatesList.innerHTML = '';
            
            if (candidates.length === 0) {
                adminCandidatesList.innerHTML = `
                    <div class="text-center text-gray-500 py-6">
                        暂无候选人，请添加
                    </div>
                `;
                return;
            }
            
            candidates.forEach(candidate => {
                const adminCandidateItem = document.createElement('div');
                adminCandidateItem.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center';
                
                adminCandidateItem.innerHTML = `
                    <div class="flex items-center">
                        <img src="${candidate.image}" alt="${candidate.name}的照片" class="w-12 h-12 rounded object-cover mr-3">
                        <div>
                            <p class="font-semibold text-dark">${candidate.name} (${candidate.className})</p>
                            <p class="text-sm text-gray-500">票数: ${candidate.votes}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-candidate bg-secondary hover:bg-secondary/90 text-white px-3 py-1 rounded text-sm" data-id="${candidate.id}">
                            <i class="fa fa-pencil mr-1"></i>编辑
                        </button>
                        <button class="delete-candidate bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm" data-id="${candidate.id}">
                            <i class="fa fa-trash mr-1"></i>删除
                        </button>
                    </div>
                `;
                
                adminCandidatesList.appendChild(adminCandidateItem);
            });
            
            // 添加编辑和删除候选人事件监听
            document.querySelectorAll('.edit-candidate').forEach(btn => {
                btn.addEventListener('click', handleEditCandidate);
            });
            
            document.querySelectorAll('.delete-candidate').forEach(btn => {
                btn.addEventListener('click', handleDeleteCandidate);
            });
        }
        
        // 更新统计数据
        function updateStatistics() {
            totalCandidatesEl.textContent = candidates.length;
            
            const totalVotes = candidates.reduce((sum, candidate) => sum + candidate.votes, 0);
            totalVotesEl.textContent = totalVotes;
            
            totalCommentsEl.textContent = comments.length;
        }
        
        // 处理投票
        function handleVote(e) {
            const candidateId = e.target.dataset.id;
            
            // 找到对应的候选人并增加票数
            const candidateIndex = candidates.findIndex(c => c.id === candidateId);
            if (candidateIndex !== -1) {
                candidates[candidateIndex].votes++;
                
                // 更新投票状态
                hasVoted = true;
                votedCandidateId = candidateId;
                
                // 保存数据
                saveCandidates();
                saveVoteStatus();
                
                // 更新UI
                updateUI();
                
                // 添加投票动画
                e.target.classList.add('vote-animation');
                
                // 显示投票成功提示
                alert('投票成功！感谢您的参与。');
            }
        }
        
        // 处理提交评论
        function handleSubmitComment() {
            const commentContent = commentInput.value.trim();
            
            if (!commentContent) {
                alert('请输入评论内容');
                return;
            }
            
            // 创建新评论
            const newComment = {
                id: Date.now().toString(),
                userId: Math.floor(Math.random() * 10000).toString().padStart(4, '0'), // 生成随机用户ID
                content: commentContent,
                timestamp: new Date().toISOString()
            };
            
            // 添加到评论列表
            comments.push(newComment);
            
            // 保存评论
            saveComments();
            
            // 清空输入框
            commentInput.value = '';
            
            // 更新UI
            updateUI();
        }
        
        // 处理管理员登录
        function handleAdminLogin() {
            const password = adminPasswordInput.value.trim();
            
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                adminLoginMessage.textContent = '登录成功！';
                adminLoginMessage.className = 'text-xs mt-2 text-green-400 text-center md:text-right';
                adminPasswordInput.value = '';
                
                // 显示管理员面板
                adminPanel.classList.remove('hidden');
                
                // 更新UI
                updateUI();
            } else {
                adminLoginMessage.textContent = '密码错误，请重试';
                adminLoginMessage.className = 'text-xs mt-2 text-red-400 text-center md:text-right';
            }
            
            // 3秒后隐藏消息
            setTimeout(() => {
                adminLoginMessage.classList.add('hidden');
            }, 3000);
        }
        
        // 处理添加候选人
        function handleAddCandidate() {
            // 重置表单
            candidateForm.reset();
            candidateIdInput.value = '';
            modalTitle.textContent = '添加新候选人';
            votesInputContainer.classList.add('hidden');
            
            // 显示弹窗
            candidateModal.classList.remove('hidden');
        }
        
        // 处理编辑候选人
        function handleEditCandidate(e) {
            const candidateId = e.target.closest('.edit-candidate').dataset.id;
            const candidate = candidates.find(c => c.id === candidateId);
            
            if (candidate) {
                // 填充表单
                candidateIdInput.value = candidate.id;
                document.getElementById('candidate-name').value = candidate.name;
                document.getElementById('candidate-class').value = candidate.className;
                document.getElementById('candidate-desc').value = candidate.description;
                document.getElementById('candidate-image').value = candidate.image;
                document.getElementById('candidate-votes').value = candidate.votes;
                
                modalTitle.textContent = '编辑候选人';
                votesInputContainer.classList.remove('hidden');
                
                // 显示弹窗
                candidateModal.classList.remove('hidden');
            }
        }
        
        // 处理删除候选人
        function handleDeleteCandidate(e) {
            const candidateId = e.target.closest('.delete-candidate').dataset.id;
            const candidate = candidates.find(c => c.id === candidateId);
            
            if (candidate) {
                // 显示确认弹窗
                confirmMessageEl.textContent = `您确定要删除候选人 ${candidate.name} 吗？此操作不可撤销。`;
                confirmModal.classList.remove('hidden');
                
                // 设置确认操作
                const confirmAction = () => {
                    // 从数组中删除候选人
                    candidates = candidates.filter(c => c.id !== candidateId);
                    
                    // 保存数据
                    saveCandidates();
                    
                    // 更新UI
                    updateUI();
                    
                    // 关闭确认弹窗
                    confirmModal.classList.add('hidden');
                };
                
                // 绑定确认事件（先移除之前的事件）
                confirmActionBtn.removeEventListener('click', confirmAction);
                confirmActionBtn.addEventListener('click', confirmAction, { once: true });
            }
        }
        
        // 处理删除评论
        function handleDeleteComment(e) {
            const commentIndex = parseInt(e.target.closest('.delete-comment').dataset.index);
            
            // 显示确认弹窗
            confirmMessageEl.textContent = '您确定要删除这条评论吗？';
            confirmModal.classList.remove('hidden');
            
            // 设置确认操作
            const confirmAction = () => {
                // 从数组中删除评论
                comments.splice(commentIndex, 1);
                
                // 保存数据
                saveComments();
                
                // 更新UI
                updateUI();
                
                // 关闭确认弹窗
                confirmModal.classList.add('hidden');
            };
            
            // 绑定确认事件（先移除之前的事件）
            confirmActionBtn.removeEventListener('click', confirmAction);
            confirmActionBtn.addEventListener('click', confirmAction, { once: true });
        }
        
        // 处理保存候选人（添加或编辑）
        function handleSaveCandidate(e) {
            e.preventDefault();
            
            const id = candidateIdInput.value || Date.now().toString();
            const name = document.getElementById('candidate-name').value.trim();
            const className = document.getElementById('candidate-class').value.trim();
            const description = document.getElementById('candidate-desc').value.trim();
            const image = document.getElementById('candidate-image').value.trim();
            const votes = candidateIdInput.value ? parseInt(document.getElementById('candidate-votes').value) : 0;
            
            if (!name || !className || !description || !image) {
                alert('请填写所有必填字段');
                return;
            }
            
            const candidateData = {
                id,
                name,
                className,
                description,
                image,
                votes
            };
            
            if (candidateIdInput.value) {
                // 编辑现有候选人
                const index = candidates.findIndex(c => c.id === id);
                if (index !== -1) {
                    candidates[index] = candidateData;
                }
            } else {
                // 添加新候选人
                candidates.push(candidateData);
            }
            
            // 保存数据
            saveCandidates();
            
            // 关闭弹窗
            candidateModal.classList.add('hidden');
            
            // 更新UI
            updateUI();
        }
        
        // 处理重置所有数据
        function handleResetAllData() {
            // 显示确认弹窗
            confirmMessageEl.textContent = '您确定要重置所有数据吗？这将删除所有候选人、投票和评论，且不可恢复！';
            confirmModal.classList.remove('hidden');
            
            // 设置确认操作
            const confirmAction = () => {
                // 重置数据
                candidates = [];
                comments = [];
                hasVoted = false;
                votedCandidateId = null;
                
                // 保存数据
                saveCandidates();
                saveComments();
                saveVoteStatus();
                
                // 更新UI
                updateUI();
                
                // 关闭确认弹窗
                confirmModal.classList.add('hidden');
            };
            
            // 绑定确认事件（先移除之前的事件）
            confirmActionBtn.removeEventListener('click', confirmAction);
            confirmActionBtn.addEventListener('click', confirmAction, { once: true });
        }
        
        // 设置所有事件监听器
        function setupEventListeners() {
            // 评论提交
            submitCommentBtn.addEventListener('click', handleSubmitComment);
            
            // 管理员登录
            adminLoginBtn.addEventListener('click', handleAdminLogin);
            adminPasswordInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') handleAdminLogin();
            });
            
            // 关闭管理员面板
            closeAdminPanelBtn.addEventListener('click', () => {
                adminPanel.classList.add('hidden');
            });
            
            // 添加候选人
            addCandidateBtn.addEventListener('click', handleAddCandidate);
            
            // 关闭候选人弹窗
            closeModalBtn.addEventListener('click', () => {
                candidateModal.classList.add('hidden');
            });
            cancelCandidateBtn.addEventListener('click', () => {
                candidateModal.classList.add('hidden');
            });
            
            // 保存候选人
            candidateForm.addEventListener('submit', handleSaveCandidate);
            
            // 重置所有数据
            resetAllDataBtn.addEventListener('click', handleResetAllData);
            
            // 规则弹窗
            rulesBtn.addEventListener('click', () => {
                rulesModal.classList.remove('hidden');
            });
            closeRulesModalBtn.addEventListener('click', () => {
                rulesModal.classList.add('hidden');
            });
            
            // 取消确认
            cancelConfirmBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });
            
            // 点击弹窗外部关闭弹窗
            window.addEventListener('click', e => {
                if (e.target === candidateModal) {
                    candidateModal.classList.add('hidden');
                }
                if (e.target === adminPanel) {
                    adminPanel.classList.add('hidden');
                }
                if (e.target === rulesModal) {
                    rulesModal.classList.remove('hidden');
                }
                if (e.target === confirmModal) {
                    confirmModal.classList.add('hidden');
                }
            });
            
            // 滚动时改变header样式
            window.addEventListener('scroll', () => {
                const header = document.querySelector('header');
                if (window.scrollY > 10) {
                    header.classList.add('py-2');
                    header.classList.remove('py-4');
                } else {
                    header.classList.add('py-4');
                    header.classList.remove('py-2');
                }
            });
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
